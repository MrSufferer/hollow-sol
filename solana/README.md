# Solana Mixer

This directory contains the Solana implementation of the mixer dApp using Noir circuits and Sunspot for zero-knowledge proof verification.

## Architecture

The mixer consists of **two distinct Solana programs**:

1. **Verifier Program** (deployed at `D9YEdaR4MT37wUP1GZ1CmrirMtRsegG7gibX3rLb7sgD` on devnet):
   - Generated by Sunspot from the Noir circuit
   - Handles Groth16 proof verification
   - Called via Cross-Program Invocation (CPI) from the mixer program

2. **Mixer Program** (to be deployed):
   - Application logic for the mixer
   - Maintains Merkle root history and nullifier tracking
   - Processes deposits (push roots) and withdrawals (verify proofs via CPI)
   - Manages the mixer vault (pool of funds)

## Prerequisites

- **Noir 1.0.0-beta.18+**: `noirup -v 1.0.0-beta.18`
- **Go 1.24+**: Required for Sunspot
- **Solana CLI 3.0.13+**: `solana-install update`
- **Sunspot**: Built from [reilabs/sunspot](https://github.com/reilabs/sunspot)
- **Node.js 18+**: For TypeScript client and tests

## Setup

### 1. Build and Deploy Verifier Program

The verifier program should already be deployed. If you need to redeploy:

```bash
cd circuits
sunspot setup  # Generate proving/verifying keys
sunspot deploy target/circuits.vk  # Generate and deploy verifier program
solana program deploy target/circuits.so --url devnet
```

### 2. Build Mixer Program

```bash
cd solana
cargo-build-sbf
```

This will create `target/deploy/mixer.so`.

### 3. Deploy Mixer Program

```bash
./deploy-mixer.sh
```

Or manually:

```bash
# Generate program keypair (if needed)
solana-keygen new --outfile keypair/mixer.json --no-bip39-passphrase -s

# Deploy
solana program deploy target/deploy/mixer.so \
    --url devnet \
    --program-id keypair/mixer.json \
    --keypair keypair/deployer.json
```

### 4. Run Integration Tests

```bash
cd ts-client
npm install
export MIXER_PROGRAM_ID=<your-mixer-program-id>
npm run test
```

## Project Structure

```
solana/
├── programs/
│   └── mixer/
│       ├── src/
│       │   └── lib.rs          # Mixer program implementation
│       └── Cargo.toml
├── ts-client/
│   ├── src/
│   │   ├── integration.test.ts # Integration tests
│   │   ├── merkle-tree.ts      # Poseidon2 Merkle tree
│   │   ├── proof-helper.ts     # Sunspot proof generation
│   │   └── mixer-client.ts     # Mixer program client utilities
│   └── package.json
├── deploy-mixer.sh             # Deployment script
└── README.md
```

## How It Works

### Deposit Flow

1. User generates a commitment: `Poseidon2(nullifier, secret)`
2. Commitment is inserted into an off-chain Merkle tree
3. New Merkle root is pushed to the mixer program via `PushRoot` instruction
4. User transfers lamports to the mixer vault

### Withdrawal Flow

1. User generates a ZK proof proving:
   - They know a nullifier and secret that hash to a commitment in the Merkle tree
   - The nullifier hash matches
   - The commitment is in a known root
2. User submits `Withdraw` instruction with proof
3. Mixer program:
   - Checks the root is known
   - Checks the nullifier hasn't been used
   - CPI's into the verifier program to verify the proof
   - Transfers funds from vault to recipient
   - Marks nullifier as spent

## Troubleshooting

### Build Errors: `edition2024` required

Some Cargo dependencies require Rust edition 2024, but the Solana toolchain may not support it. Workaround:

```bash
# Fix cached registry files
cd ~/.cargo/registry/src/index.crates.io-*/
for dir in constant_time_eq-0.4.2 blake3-1.8.3 base64ct-1.8.3; do
  if [ -f "$dir/Cargo.toml.orig" ] && [ ! -f "$dir/Cargo.toml" ]; then
    cp "$dir/Cargo.toml.orig" "$dir/Cargo.toml"
    sed -i.bak 's/edition = "2024"/edition = "2021"/' "$dir/Cargo.toml"
  fi
done
```

### Deployment: Insufficient Funds

```bash
solana airdrop 2 <deployer-address> --url devnet
```

### CPI Verification Fails

Ensure the proof format matches Sunspot's expected format:
- Instruction data to verifier: `proof_bytes || public_witness_bytes`
- `public_witness_bytes` is the `.pw` file from Sunspot (contains root || nullifier_hash || recipient_field)

## References

- [Noir Examples](https://github.com/solana-foundation/noir-examples)
- [Sunspot](https://github.com/reilabs/sunspot)
- [Solana Program Examples](https://github.com/solana-labs/solana-program-library)
